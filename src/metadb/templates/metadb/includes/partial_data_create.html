{% load i18n %}

<form method="post" action="{% url 'metadb:data_create' %}" class="js-data-create-form" 
      dataset-resolutions-url="{% url 'metadb:api_load_resolutions'%}"
      dataset-scenario-url="{% url 'metadb:api_load_scenarios'%}"
      parameter-timesteps-url="{% url 'metadb:api_load_timesteps'%}"
      parameter-lvsgroups-url="{% url 'metadb:api_load_lvsgroups'%}"
      parameter-lvsnames-url="{% url 'metadb:api_load_lvsnames'%}" novalidate>
    {% csrf_token %}

    <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
    <h3 class="modal-title">{% trans "Create a new data" %}</h3>

    <div class="modal-body">
        {% include 'metadb/includes/partial_data_form.html' %}
    </div>

    <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Close" %}</button>
        <button type="submit" class="btn btn-primary">{% trans "Create data" %}</button>
    </div>
</form>

<script>
    var loadScenarios = function() {
        var form = $('.js-data-create-form');
        var collectionId = $('#id_collection').val();
        var resolutionId = $('#id_resolution').val();

        $.ajax( {
            url: form.attr('dataset-scenario-url'),
            type: 'get',
            data: {
                'collectionId': collectionId,
                'resolutionId': resolutionId,
            },
            success: function (data) {
                $('#id_scenario').html(data);
                if ($('#id_scenario option').length == 2) {
                    $('#id_scenario').prop("selectedIndex", 1);
                }
            }
        } );
    };

    var loadResolutions = function() {
        var form = $('.js-data-create-form');
        var collectionId = $('#id_collection').val();

        $.ajax( {
            url: form.attr('dataset-resolutions-url'),
            type: 'get',
            data: {
                'collectionId': collectionId,
            },
            success: function (data) {
                $('#id_resolution').html(data);
                if ($('#id_resolution option').length == 2) {
                    $('#id_resolution').prop("selectedIndex", 1);
                }
                $('#id_resolution').trigger('change');
            }
        } );
    };

    $('#id_collection').change( loadResolutions );
    $('#id_resolution').change( loadScenarios );


    var loadLvsGroups = function() {
        var form = $('.js-data-create-form');
        var parameteri18nId = $('#id_parameteri18n').val();
        var timestepi18nId = $('#id_time_stepi18n').val();

        $.ajax( {
            url: form.attr('parameter-lvsgroups-url'),
            type: 'get',
            data: {
                'parameteri18nId': parameteri18nId,
                'timestepi18nId': timestepi18nId,
            },
            success: function (data) {
                $('#id_levels_group').html(data);
                if ($('#id_levels_group option').length == 2) {
                    $('#id_levels_group').prop("selectedIndex", 1);
                }
                $('#id_levels_group').trigger('change');
            }
        } );
    };

    var loadTimeSteps = function() {
        var form = $('.js-data-create-form');
        var parameteri18nId = $('#id_parameteri18n').val();

        $.ajax( {
            url: form.attr('parameter-timesteps-url'),
            type: 'get',
            data: {
                'parameteri18nId': parameteri18nId,
            },
            success: function (data) {
                $('#id_time_stepi18n').html(data);
                if ($('#id_time_stepi18n option').length == 2) {
                    $('#id_time_stepi18n').prop("selectedIndex", 1);
                }
                $('#id_levels_group').trigger('change');
            }
        } );
    };

    var loadLvsNames = function() {
        var form = $('.js-data-create-form');
        var lvsgroupId = $('#id_levels_group').val();

        $.ajax( { 
            url: form.attr('parameter-lvsnames-url'),
            type: 'get',
            data: {
                'lvsgroupId': lvsgroupId,
            },
            success: function (data) {
                $('#id_levels_namesi18n').val(data);
            }
        } );
    };

    $('#id_parameteri18n').change( loadTimeSteps );
    $('#id_time_stepi18n').change( loadLvsGroups );
    $('#id_levels_group').change( loadLvsNames );

</script>
